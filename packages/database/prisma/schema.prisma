// Prisma Schema for Dental SaaS
// Multi-tenant architecture with row-level isolation

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// SUBSCRIPTION & BILLING
// ============================================================================

model Plan {
  id          String   @id @default(cuid())
  name        String   @unique // free, basic, enterprise
  displayName String
  price       Decimal  @db.Decimal(10, 2) // Monthly price in USD
  
  // Limits
  maxAdmins   Int
  maxDoctors  Int
  maxPatients Int
  
  // Features (stored as JSON for flexibility)
  features    Json     @default("[]")
  
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  subscriptions Subscription[]

  @@map("plans")
}

model Subscription {
  id                   String             @id @default(cuid())
  tenantId             String
  planId               String
  status               SubscriptionStatus @default(ACTIVE)
  
  // Stripe integration
  stripeCustomerId     String?
  stripeSubscriptionId String?
  
  // Billing period
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean            @default(false)
  
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plan   Plan   @relation(fields: [planId], references: [id], onDelete: Restrict)

  @@unique([tenantId])
  @@index([planId])
  @@index([status])
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@map("subscriptions")
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  TRIALING
  PAUSED
}

// ============================================================================
// MULTI-TENANCY
// ============================================================================

model Tenant {
  id        String   @id @default(cuid())
  name      String   // Clinic name
  /// URL-friendly identifier. Must be validated at application level
  /// to contain only lowercase letters, numbers, and hyphens.
  slug      String   @unique
  
  // Contact info
  email     String?
  phone     String?
  address   String?  @db.Text
  
  // Branding
  logo      String?  // URL to logo
  /// IANA timezone identifier (e.g., "America/New_York", "Europe/London")
  timezone  String   @default("America/New_York")
  /// ISO 4217 currency code (e.g., USD, EUR, GBP)
  currency  String   @db.Char(3) @default("USD")
  
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subscription Subscription?
  users        User[]
  patients     Patient[]
  doctors      Doctor[]

  @@index([slug])
  @@index([isActive])
  @@map("tenants")
}

// ============================================================================
// USERS & AUTHENTICATION
// ============================================================================

model User {
  id             String    @id @default(cuid())
  tenantId       String
  
  /// Email address. Must be validated at application level for format.
  email          String
  /// Hashed password using bcrypt/argon2. NEVER expose in API responses.
  /// When querying users, always exclude this field from selections.
  passwordHash   String    @db.VarChar(255)
  
  firstName      String
  lastName       String
  role           UserRole  @default(STAFF)
  
  // Profile
  avatar         String?   // URL to avatar
  phone          String?
  
  // Auth
  emailVerified  Boolean   @default(false)
  lastLoginAt    DateTime?
  
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  tenant         Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  refreshTokens  RefreshToken[]

  @@unique([tenantId, email]) // Email unique per tenant
  @@index([tenantId])
  @@index([email])
  @@index([role])
  @@index([tenantId, role])
  @@index([isActive])
  @@map("users")
}

// ============================================================================
// PATIENTS
// ============================================================================

model Patient {
  id         String   @id @default(cuid())
  tenantId   String

  firstName  String
  lastName   String
  email      String?  
  phone      String?
  dob        DateTime?
  gender     String?  @db.VarChar(20)
  address    String?  @db.Text
  notes      Json?

  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([lastName])
  @@unique([tenantId, email])
  @@map("patients")
}

// ============================================================================
// DOCTORS
// ============================================================================

model Doctor {
  id             String   @id @default(cuid())
  tenantId       String

  firstName      String
  lastName       String
  email          String?
  phone          String?
  
  /// Medical specialty (e.g., "General Dentistry", "Orthodontics")
  specialty      String?
  /// Professional license number
  licenseNumber  String?
  
  /// Working days as JSON array (e.g., ["MON", "TUE", "WED"])
  workingDays    Json     @default("[]")
  /// Working hours as JSON (e.g., {"start": "09:00", "end": "18:00"})
  workingHours   Json?
  
  /// Consultation room or office number
  consultingRoom String?
  
  /// Profile photo URL
  avatar         String?
  /// Bio or professional summary
  bio            String?  @db.Text
  
  /// Hourly rate for billing purposes
  hourlyRate     Decimal? @db.Decimal(10, 2)

  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([lastName])
  @@unique([tenantId, email])
  @@unique([tenantId, licenseNumber])
  @@map("doctors")
}

enum UserRole {
  OWNER   // Tenant owner, full access
  ADMIN   // Administrative access
  DOCTOR  // Can manage patients and appointments
  STAFF   // Limited access
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  /// Stores a securely hashed refresh token, not the raw token.
  /// Hash the token before storing and compare hashes on validation.
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}
