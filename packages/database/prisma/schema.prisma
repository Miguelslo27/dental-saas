// Prisma Schema for Dental SaaS
// Multi-tenant architecture with row-level isolation

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// SUBSCRIPTION & BILLING
// ============================================================================

model Plan {
  id          String   @id @default(cuid())
  name        String   @unique // free, basic, enterprise
  displayName String
  price       Decimal  @db.Decimal(10, 2) // Monthly price in USD
  
  // Limits
  maxAdmins   Int
  maxDoctors  Int
  maxPatients Int
  
  // Features (stored as JSON for flexibility)
  features    Json     @default("[]")
  
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  subscriptions Subscription[]

  @@map("plans")
}

model Subscription {
  id                   String             @id @default(cuid())
  tenantId             String
  planId               String
  status               SubscriptionStatus @default(ACTIVE)
  
  // Stripe integration
  stripeCustomerId     String?
  stripeSubscriptionId String?
  
  // Billing period
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean            @default(false)
  
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plan   Plan   @relation(fields: [planId], references: [id])

  @@unique([tenantId])
  @@index([planId])
  @@index([status])
  @@map("subscriptions")
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  TRIALING
  PAUSED
}

// ============================================================================
// MULTI-TENANCY
// ============================================================================

model Tenant {
  id        String   @id @default(cuid())
  name      String   // Clinic name
  slug      String   @unique // URL-friendly identifier
  
  // Contact info
  email     String?
  phone     String?
  address   String?  @db.Text
  
  // Branding
  logo      String?  // URL to logo
  timezone  String   @default("America/New_York")
  currency  String   @default("USD")
  
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subscription Subscription?
  users        User[]

  @@index([slug])
  @@index([isActive])
  @@map("tenants")
}

// ============================================================================
// USERS & AUTHENTICATION
// ============================================================================

model User {
  id             String    @id @default(cuid())
  tenantId       String
  
  email          String
  passwordHash   String
  
  firstName      String
  lastName       String
  role           UserRole  @default(STAFF)
  
  // Profile
  avatar         String?   // URL to avatar
  phone          String?
  
  // Auth
  emailVerified  Boolean   @default(false)
  lastLoginAt    DateTime?
  
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  tenant         Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  refreshTokens  RefreshToken[]

  @@unique([tenantId, email]) // Email unique per tenant
  @@index([email])
  @@index([role])
  @@index([isActive])
  @@map("users")
}

enum UserRole {
  OWNER   // Tenant owner, full access
  ADMIN   // Administrative access
  DOCTOR  // Can manage patients and appointments
  STAFF   // Limited access
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}
