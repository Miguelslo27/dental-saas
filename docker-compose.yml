# docker-compose.yml - default production configuration for Coolify
#
# NOTE: Default values are provided for preview deployments.
# Production deployments MUST override these via Coolify environment variables.
services:
  dental-postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      # Defaults for preview deployments (override in Coolify for production)
      POSTGRES_DB: ${POSTGRES_DB:-dental_preview}
      POSTGRES_USER: ${POSTGRES_USER:-dental_preview}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-preview_password_not_for_production}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - dental-network
    healthcheck:
      # Uses default values if env vars not set (for preview deployments)
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${POSTGRES_USER:-dental_preview} -d ${POSTGRES_DB:-dental_preview}",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    # SECURITY NOTE: The password will be visible in `docker inspect`.
    # For high-risk production environments, consider using Redis ACLs or Docker secrets.
    command:
      [
        "redis-server",
        "--requirepass",
        "${REDIS_PASSWORD:-preview_redis_password}",
        "--appendonly",
        "yes",
        "--appendfsync",
        "everysec",
      ]
    environment:
      # Use REDISCLI_AUTH to avoid exposing password in command line arguments
      REDISCLI_AUTH: ${REDIS_PASSWORD:-preview_redis_password}
    volumes:
      - redis_data:/data
    networks:
      - dental-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  api:
    build:
      context: .
      dockerfile: ./apps/api/Dockerfile
    restart: unless-stopped
    # Graceful shutdown: allow the API to finish in-flight requests before Docker forcefully stops the container.
    stop_grace_period: 30s
    environment:
      NODE_ENV: production
      PORT: ${PORT:-5001}
      # Defaults for preview deployments (override in Coolify for production)
      # NOTE: Passwords should use alphanumeric characters only to avoid URL encoding issues
      # IMPORTANT: Using "dental-postgres" as hostname to avoid conflicts with Coolify's postgres service
      DATABASE_URL: postgresql://${POSTGRES_USER:-dental_preview}:${POSTGRES_PASSWORD:-preview_password_not_for_production}@dental-postgres:5432/${POSTGRES_DB:-dental_preview}?schema=public
      REDIS_URL: redis://:${REDIS_PASSWORD:-preview_redis_password}@redis:6379
      # CORS_ORIGIN must match the public URL of the frontend in production.
      # Expected format: "https://example.com" (no trailing slash).
      # Do NOT use localhost values (e.g. http://localhost:5001) in production.
      CORS_ORIGIN: ${CORS_ORIGIN:-*}
      JWT_SECRET: ${JWT_SECRET:-preview_jwt_secret_not_for_production_use}
      JWT_ACCESS_EXPIRES_IN: ${JWT_ACCESS_EXPIRES_IN:-15m}
      JWT_REFRESH_EXPIRES_IN: ${JWT_REFRESH_EXPIRES_IN:-7d}
      SETUP_KEY: ${SETUP_KEY:-preview_setup_key}
      # Email (Resend) - optional, emails will be skipped if not configured
      RESEND_API_KEY: ${RESEND_API_KEY:-}
      EMAIL_FROM: ${EMAIL_FROM:-Alveo System <onboarding@resend.dev>}
    # NOTE: Coolify handles routing via its reverse proxy (Traefik).
    # Do not expose ports directly - use Coolify's domain configuration instead.
    volumes:
      - uploads_data:/app/apps/api/uploads
    depends_on:
      dental-postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - dental-network
      - coolify
    # Healthcheck ensures container is ready before receiving traffic
    healthcheck:
      test:
        ["CMD", "wget", "-q", "--spider", "http://localhost:${PORT:-5001}/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    # NOTE: Do NOT add custom traefik.http.services.* labels here.
    # Coolify auto-generates Traefik routing labels and custom ones create
    # conflicting service definitions that cause gateway timeouts.

  web:
    build:
      context: .
      dockerfile: ./apps/web/Dockerfile
      args:
        # URL of the app (panel) for external links
        VITE_APP_URL: ${VITE_APP_URL:-}
    restart: unless-stopped
    stop_grace_period: 30s
    depends_on:
      - api
    networks:
      - dental-network
      - coolify

  app:
    build:
      context: .
      dockerfile: ./apps/app/Dockerfile
      args:
        # Default empty allows build; Coolify injects actual URL for production
        VITE_API_URL: ${VITE_API_URL:-}
    restart: unless-stopped
    # Graceful shutdown: allow in-flight requests to complete before the container is forcefully stopped
    stop_grace_period: 30s
    # NOTE: Coolify handles routing via its reverse proxy (Traefik).
    # Do not expose ports directly - use Coolify's domain configuration instead.
    depends_on:
      - api
    networks:
      - dental-network
      - coolify
    # NOTE: Do NOT add custom traefik.http.services.* labels here.
    # Coolify auto-generates Traefik routing labels and custom ones create
    # conflicting service definitions that cause gateway timeouts.

networks:
  dental-network:
    driver: bridge
  coolify:
    external: true

volumes:
  postgres_data:
  redis_data:
  uploads_data:
